<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AetherisLab</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jost:wght@200;300;400&display=swap');
        body {
            text-align: center;
            font-family: 'Jost', Helvetica, sans-serif;
            font-weight: 300;
            background-color: #fbebdc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
            overflow-x: hidden;
            overflow-y: auto;
            color: #333;
            letter-spacing: 0.03em;
            padding: 100px 0 60px 0; /* Top padding for title, bottom for progress bar */
            box-sizing: border-box; /* Make sure padding is included in element's total height */

        }
        h1 {
            position: fixed;
            top: 40px;
            width: 100%;
            text-align: center;
            font-weight: 200;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #f4634c;
            font-size: 36px;
            margin: 0;
        }
        button {
            font-family: 'Jost', Helvetica, sans-serif;
            font-weight: 300;
            font-size: 16px;
            padding: 12px 28px;
            cursor: pointer;
            margin: 12px;
            border-radius: 2px;
            background-color: #f4634c;
            color: white;
            border: none;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.3s ease;
        }
        button:hover {
            background-color: #fba899;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(244, 99, 76, 0.2);
        }
        #arrowContainer {
            font-size: 100px;
            margin-top: 20px;
            display: none;
            color: #f4634c;
            white-space: nowrap;
            overflow: hidden;
            padding: 0 10px;
        }
        @media (max-width: 600px) {
            #arrowContainer {
                font-size: 60px;
            }
        }
        @media (max-width: 400px) {
            #arrowContainer {
                font-size: 40px;
            }
        }
        #result {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 500px;
            width: 90%;
            margin: 20px auto;
            text-align: center;
            line-height: 1.6;
        }
        #result p {
            margin: 16px 0;
            font-size: 18px;
        }
        #result p strong {
            color: #f4634c;
            font-weight: 400;
        }
        #alertingTestScreen p {
            font-size: 80px;
            display: none;
            color: #f4634c;
        }
        #progressBarContainer {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            max-width: 400px;
            background-color: #fba899;
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }
        #progressBar {
            height: 100%;
            background-color: #f4634c;
            width: 0;
            transition: width 0.3s ease-out;
        }
        .instruction-screen {
            background-color: white;
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 500px;
            width: 90%;
            margin: 0 auto;
        }
        .instruction-screen p {
            margin: 15px 0;
            line-height: 1.6;
        }
        .instruction-screen p strong {
            color: #f4634c;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: block;
            margin-bottom: 10px;
            font-size: 18px;
        }
        #touchButtonsContainer {
            display: none;
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            text-align: center;
        }
        .touch-button {
            width: 45%;
            height: 70px;
            font-size: 24px;
            margin: 0 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #f4634c !important;
            color: white !important;
            transform: none !important;
            box-shadow: none !important;
            transition: none !important;
            position: relative;
            max-width: 200px;
        }
        .touch-button:hover, .touch-button:active, .touch-button.active {
            background-color: #f4634c !important;
            color: white !important;
            transform: none !important;
            box-shadow: none !important;
        }
        #spaceButton {
            width: 90%;
            max-width: 400px;
            height: 70px;
            font-size: 24px;
            display: none;
            background-color: #f4634c !important;
            color: white !important;
            transform: none !important;
            box-shadow: none !important;
            transition: none !important;
            margin: 0 auto;
        }
        #spaceButton:hover, #spaceButton:active {
            background-color: #f4634c !important;
            color: white !important;
            transform: none !important;
            box-shadow: none !important;
        }
        #deviceSelectionScreen {
            display: none;
            background-color: white;
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 500px;
            width: 90%;
            margin: 0 auto;
        }
        #participantInfoScreen {
            display: none;
            background-color: white;
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 500px;
            width: 90%;
            margin: 0 auto;
        }
        .input-field {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Jost', Helvetica, sans-serif;
            font-size: 16px;
        }
        #countdownContainer {
            display: none;
            font-size: 120px;
            color: #f4634c;
            font-weight: 200;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
      
        
        /* Add these media queries for better mobile responsiveness */
        @media (max-width: 480px) {
            #arrowContainer {
                font-size: 40px;
                /* Center the arrows container */
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 100%;
            }

            .instruction-screen, #result {
                padding: 20px;
            }

            h1 {
                font-size: 28px;
            }
        }

        /* Add this to ensure content is centered on all devices */
        @media (max-height: 700px) {
            body {
                padding: 80px 0 80px 0;
            }

            h1 {
                top: 20px;
            }
        }
    </style>
</head>
<body>
    <h1>AetherisLab</h1>
    <button id="startButton">Begin Assessment</button>
    <div id="testExplanation">
        <p>The assessment is based on a clinically-validated methodology to detect cognitive disorders.      </p>
        <p>This quick, non-invasive test measures attention patterns that may indicate depression, burnout, cognitive fatigue, or early dementia markers.</p>
        <p>Your results are completely confidential and can provide valuable insights for your mental wellness journey. However, they do NOT replace diagnosis and treatment from qualified professionals.</p>
    </div>
    <div id="arrowContainer"></div>
    <div id="result"></div>
    <button id="restartButton" style="display: none;">Take Test Again</button>
    <div id="countdownContainer">3</div>
  
    <div id="participantInfoScreen" class="instruction-screen">
        <p><strong>Participant Information</strong></p>
        <p>Please enter your information before proceeding:</p>
        <input type="text" id="participantAge" class="input-field" placeholder="Age">
        <select id="participantGender" class="input-field">
            <option value="">Select Gender</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
            <option value="prefer-not-to-say">Prefer not to say</option>
        </select>
        <input type="text" id="participantId" class="input-field" placeholder="Participant ID - If any">

        <div id="disclaimerContainer" style="margin: 20px 0; padding: 15px; background-color: #f8f8f8; border-radius: 4px; border-left: 4px solid #4682B4; text-align: left;">
            <p style="font-weight: bold; margin-bottom: 10px;">Disclaimer</p>
            <p style="font-size: 14px; line-height: 1.5; margin-bottom: 15px;">
                This cognitive assessment is intended for informational purposes only and is not a clinical diagnostic tool. Results should not be interpreted as medical advice. AetherisLab does not provide medical diagnoses, treatment recommendations, or other medical services. If you have concerns about your cognitive health, please consult with a qualified healthcare professional.
            </p>
            <div style="display: flex; align-items: center; margin-top: 10px;">
                <input type="checkbox" id="disclaimerCheckbox" style="margin-right: 10px;">
                <label for="disclaimerCheckbox" style="font-size: 14px;">I understand and agree to the above disclaimer</label>
            </div>
        </div>

        <button id="submitParticipantInfo" disabled style="opacity: 0.6; cursor: not-allowed;">Continue</button>
    </div>
  
    <div id="deviceSelectionScreen" class="instruction-screen">
        <p><strong>Choose Your Device</strong></p>
        <p>Select how you would like to interact with this test:</p>
        <button id="keyboardButton">Physical Keyboard</button>
        <button id="touchscreenButton">Touchscreen Device</button>
    </div>
    <div id="instructionsScreen" class="instruction-screen" style="display: none;">
        <p><strong>Section 1: Arrow Direction Task</strong></p>
        <div style="margin: 20px 0;">
            <p style="font-weight: 400; margin-bottom: 15px;">In this task:</p>
            <ol style="text-align: left; line-height: 1.6;">
                <li><span style="font-weight: 400;">Focus on the <span style="color: #f4634c; text-decoration: underline;">center arrow</span> and ignore the surrounding ones</span></li>
                <li><span style="font-weight: 400;">Press the arrow key that matches the direction of the center arrow</span></li>
                <li><span style="font-weight: 400;">Respond as <span style="color: #f4634c; font-weight: 400;">quickly and accurately</span> as possible</span></li>
            </ol>
        </div>

        <div style="margin: 25px 0; background-color: #f8f8f8; padding: 15px; border-radius: 4px;">
            <p style="font-weight: 400; margin-bottom: 10px;">Examples:</p>

            <div style="display: flex; justify-content: space-between; margin: 15px 0;">
                <div style="text-align: center; width: 48%;">
                    <div style="font-size: 24px; margin-bottom: 10px;">
                        <span style="color: #888;">→ →</span> <span style="color: #f4634c; font-weight: bold;">→</span> <span style="color: #888;">→ →</span>
                    </div>
                    <div style="background-color: #e6f7e6; padding: 8px; border-radius: 3px; border: 1px solid #c3e6c3;">
                        Press <span style="font-weight: bold;">→</span> key
                    </div>
                </div>

                <div style="text-align: center; width: 48%;">
                    <div style="font-size: 24px; margin-bottom: 10px;">
                        <span style="color: #888;">← ←</span> <span style="color: #f4634c; font-weight: bold;">→</span> <span style="color: #888;">← ←</span>
                    </div>
                    <div style="background-color: #e6f7e6; padding: 8px; border-radius: 3px; border: 1px solid #c3e6c3;">
                        Press <span style="font-weight: bold;">→</span> key
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; margin: 15px 0;">
                <div style="text-align: center; width: 48%;">
                    <div style="font-size: 24px; margin-bottom: 10px;">
                        <span style="color: #888;">← ←</span> <span style="color: #f4634c; font-weight: bold;">←</span> <span style="color: #888;">← ←</span>
                    </div>
                    <div style="background-color: #e6f7e6; padding: 8px; border-radius: 3px; border: 1px solid #c3e6c3;">
                        Press <span style="font-weight: bold;">←</span> key
                    </div>
                </div>

                <div style="text-align: center; width: 48%;">
                    <div style="font-size: 24px; margin-bottom: 10px;">
                        <span style="color: #888;">→ →</span> <span style="color: #f4634c; font-weight: bold;">←</span> <span style="color: #888;">→ →</span>
                    </div>
                    <div style="background-color: #e6f7e6; padding: 8px; border-radius: 3px; border: 1px solid #c3e6c3;">
                        Press <span style="font-weight: bold;">←</span> key
                    </div>
                </div>
            </div>
          <button id="understoodButton">Continue</button>
        </div>

        <div style="margin: 20px 0; padding: 12px; background-color: #fff4f2; border-left: 4px solid #f4634c; font-weight: 400;">
            Speed matters! Your reaction time will be measured.
        </div>
    </div>  
  
      <div id="reversedInstructionsScreen" class="instruction-screen" style="display: none;">
        <p><strong>Section 2: Reversed Arrow Task</strong></p>
        <div style="margin: 20px 0;">
            <p style="font-weight: 400; margin-bottom: 15px;">In this task:</p>
            <ol style="text-align: left; line-height: 1.6;">
                <li><span style="font-weight: 400;">Focus on the <span style="color: #f4634c; text-decoration: underline;">center arrow</span> and ignore the surrounding ones</span></li>
                <li><span style="font-weight: 400;">Press the <span style="color: #f4634c; font-weight: 400;">OPPOSITE</span> arrow key to the direction of the center arrow</span></li>
                <li><span style="font-weight: 400;">Respond as <span style="color: #f4634c; font-weight: 400;">quickly and accurately</span> as possible</span></li>
            </ol>
        </div>

        <div style="margin: 25px 0; background-color: #f8f8f8; padding: 15px; border-radius: 4px;">
            <p style="font-weight: 400; margin-bottom: 10px;">Examples:</p>

            <div style="display: flex; justify-content: space-between; margin: 15px 0;">
                <div style="text-align: center; width: 48%;">
                    <div style="font-size: 24px; margin-bottom: 10px;">
                        <span style="color: #888;">→ →</span> <span style="color: #f4634c; font-weight: bold;">→</span> <span style="color: #888;">→ →</span>
                    </div>
                    <div style="background-color: #e6f7e6; padding: 8px; border-radius: 3px; border: 1px solid #c3e6c3;">
                        Press <span style="font-weight: bold;">←</span> key (opposite)
                    </div>
                </div>

                <div style="text-align: center; width: 48%;">
                    <div style="font-size: 24px; margin-bottom: 10px;">
                        <span style="color: #888;">← ←</span> <span style="color: #f4634c; font-weight: bold;">→</span> <span style="color: #888;">← ←</span>
                    </div>
                    <div style="background-color: #e6f7e6; padding: 8px; border-radius: 3px; border: 1px solid #c3e6c3;">
                        Press <span style="font-weight: bold;">←</span> key (opposite)
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; margin: 15px 0;">
                <div style="text-align: center; width: 48%;">
                    <div style="font-size: 24px; margin-bottom: 10px;">
                        <span style="color: #888;">← ←</span> <span style="color: #f4634c; font-weight: bold;">←</span> <span style="color: #888;">← ←</span>
                    </div>
                    <div style="background-color: #e6f7e6; padding: 8px; border-radius: 3px; border: 1px solid #c3e6c3;">
                        Press <span style="font-weight: bold;">→</span> key (opposite)
                    </div>
                </div>

                <div style="text-align: center; width: 48%;">
                    <div style="font-size: 24px; margin-bottom: 10px;">
                        <span style="color: #888;">→ →</span> <span style="color: #f4634c; font-weight: bold;">←</span> <span style="color: #888;">→ →</span>
                    </div>
                    <div style="background-color: #e6f7e6; padding: 8px; border-radius: 3px; border: 1px solid #c3e6c3;">
                        Press <span style="font-weight: bold;">→</span> key (opposite)
                    </div>
                </div>
            </div>
        </div>

        <div style="margin: 20px 0; padding: 12px; background-color: #fff4f2; border-left: 4px solid #f4634c; font-weight: 400;">
            Remember: Press the OPPOSITE arrow key and respond as quickly as possible!
        </div>

        <button id="understoodReversedButton">Start Test</button>
    </div>
  
    <div id="alertingInstructionsScreen" class="instruction-screen" style="display: none;">
        <p><strong>Section 3: Reaction Speed Test</strong></p>
        <div style="margin: 20px 0;">
            <p style="font-weight: 400; margin-bottom: 15px;">In this task:</p>
            <ol style="text-align: left; line-height: 1.6;">
                <li><span style="font-weight: 400;">Keep your eyes on the center of the screen</span></li>
                <li><span style="font-weight: 400;">When you see the dot (●) appear, press the <span style="color: #f4634c; font-weight: 400;">spacebar</span> as quickly as possible</span></li>
                <li><span style="font-weight: 400;">Only press when you see the dot - <span style="color: #f4634c; font-weight: 400;">avoid pressing</span> at other times</span></li>
            </ol>
        </div>

        <div style="margin: 25px 0; background-color: #f8f8f8; padding: 15px; border-radius: 4px; text-align: center;">
            <p style="font-weight: 400; margin-bottom: 15px;">Example:</p>
            <div style="font-size: 60px; margin: 20px 0; color: #f4634c;">●</div>
            <div style="background-color: #e6f7e6; padding: 8px; border-radius: 3px; border: 1px solid #c3e6c3; max-width: 250px; margin: 0 auto;">
                Press <span style="font-weight: bold;">spacebar</span> immediately
            </div>
        </div>

        <div style="margin: 20px 0; padding: 12px; background-color: #fff4f2; border-left: 4px solid #f4634c; font-weight: 400;">
            Your goal is to react as quickly as possible when the dot appears!
        </div>

        <button id="understoodAlertingButton">Start Test</button>
    </div>
    <div id="alertingTestScreen" style="display: none;">
        <p id="alertingStimulus">●</p>
    </div>
    <div id="touchButtonsContainer">
        <button id="leftButton" class="touch-button">←</button>
        <button id="rightButton" class="touch-button">→</button>
        <button id="spaceButton" class="touch-button">Tap when you see the dot</button>
    </div>
    <div id="progressBarContainer">
        <div id="progressBar"></div>
    </div>
    <script>
        let trials = [];
        let currentTrial = 0;
        let reactionTimes = { normal: { congruent: [], incongruent: [] }, reversed: { congruent: [], incongruent: [] } };
        let wrongGuesses = { normal: 0, reversed: 0 };
        let alertingReactionTimes = [];
        let spacebarPressCount = 0;
        let alertingTestStarted = false;
        let currentPhase = "flanker";
        let currentFlankerType = "normal";
        let totalCompletedTrials = 0;
        let isTouchDevice = false;
        let alertingTestActive = false;
        const TOTAL_TRIALS = 25;
        let isFirstNormalTrial = true;
        let isFirstReversedTrial = true;
        let participantInfo = {};
        let firebaseDb;
        let sessionId;
        
        // Cutoff thresholds for risk assessment
        const CUTOFFS = {
            normalFlanker: {
                congruent: 878,
                incongruent: 954,
                wrongGuesses: 2
            },
            reversedFlanker: {
                congruent: 958,
                incongruent: 1043,
                wrongGuesses: 2
            },
            alertingTest: {
                reactionTime: 798,
                spacebarPressCount: 7
            }
        };
        
        const firebaseConfig = {
            apiKey: "AIzaSyAhm0IyK-dy62fXrnaukA6tE5bJshT7_yg",
            authDomain: "cognilabdata.firebaseapp.com",
            databaseURL: "https://cognilabdata-default-rtdb.firebaseio.com",
            projectId: "cognilabdata",
            storageBucket: "cognilabdata.firebasestorage.app",
            messagingSenderId: "377680448118",
            appId: "1:377680448118:web:07d4f27f43df9054dc2d57",
            measurementId: "G-VVL6RG6YHP"
        };
        firebase.initializeApp(firebaseConfig);
        firebaseDb = firebase.database();
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        document.getElementById("startButton").addEventListener("click", function() {
            document.getElementById('testExplanation').style.display = 'none';
            showParticipantInfoScreen();
            toggleProgressBar(false);
        });
        document.getElementById("restartButton").addEventListener("click", resetTest);
        document.getElementById("submitParticipantInfo").addEventListener("click", submitParticipantInfo);
        document.getElementById("understoodButton").addEventListener("click", () => startCountdown("normal"));
        document.getElementById("understoodReversedButton").addEventListener("click", () => startCountdown("reversed"));
        document.getElementById("understoodAlertingButton").addEventListener("click", () => startCountdown("alerting"));
        document.getElementById("keyboardButton").addEventListener("click", function() {
            isTouchDevice = false;
            document.getElementById("deviceSelectionScreen").style.display = "none";
            document.getElementById("touchButtonsContainer").style.display = "none";
            showInstructions();
        });
      
        document.getElementById("touchscreenButton").addEventListener("click", function() {
            isTouchDevice = true;
            document.getElementById("deviceSelectionScreen").style.display = "none";
            // Don't display touch buttons yet - they'll be shown when needed
            document.getElementById("touchButtonsContainer").style.display = "none";
            document.getElementById("spaceButton").style.display = "none";
            showInstructions();
        });
      
      
      
        document.getElementById("leftButton").addEventListener("click", function() {
            if (currentPhase === "flanker") {
                handleArrowPress("ArrowLeft");
            }
        });
        document.getElementById("rightButton").addEventListener("click", function() {
            if (currentPhase === "flanker") {
                handleArrowPress("ArrowRight");
            }
        });
        document.getElementById("spaceButton").addEventListener("click", function() {
            if (alertingTestStarted) {
                spacebarPressCount++;
            }
            handleSpacePress();
        });
      
      
        // Add this after your existing event listeners
        document.getElementById("disclaimerCheckbox").addEventListener("change", function() {
            const submitButton = document.getElementById("submitParticipantInfo");
            if (this.checked) {
                submitButton.disabled = false;
                submitButton.style.opacity = "1";
                submitButton.style.cursor = "pointer";
            } else {
                submitButton.disabled = true;
                submitButton.style.opacity = "0.6";
                submitButton.style.cursor = "not-allowed";
            }
        });
      
      
        // Add this function to toggle progress bar visibility
        function toggleProgressBar(show) {
            const progressBarContainer = document.getElementById("progressBarContainer");
            progressBarContainer.style.display = show ? "block" : "none";
        }
      
        // Helper function to validate email format
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
      
      
      
      // Function to handle email subscription
        function subscribeToReminders() {
            const email = document.getElementById("reminderEmail").value.trim();
            const messageElement = document.getElementById("subscriptionMessage");

            // Simple email validation
            if (!email) {
                messageElement.textContent = "Please enter your email address.";
                messageElement.style.color = "#F44336";
                messageElement.style.display = "block";
                return;
            }

            if (!isValidEmail(email)) {
                messageElement.textContent = "Please enter a valid email address.";
                messageElement.style.color = "#F44336";
                messageElement.style.display = "block";
                return;
            }

            // Prepare data for Firebase
            const reminderData = {
                email: email,
                participantId: participantInfo.participantId || "",
                subscribedAt: new Date().toISOString(),
                testSessionId: sessionId
            };

            // Save to Firebase
            firebaseDb.ref('reminderSubscriptions/' + generateUniqueId()).set(reminderData)
                .then(() => {
                    messageElement.textContent = "Thank you! You've been subscribed to test reminders.";
                    messageElement.style.color = "#4CAF50";
                    messageElement.style.display = "block";
                    document.getElementById("reminderEmail").value = "";
                    document.getElementById("subscribeButton").disabled = true;
                    document.getElementById("subscribeButton").style.backgroundColor = "#cccccc";
                });
        }
     
        // Call this at the beginning to hide progress bar initially
        toggleProgressBar(false);
                function startCountdown(testType) {
                    document.getElementById("instructionsScreen").style.display = "none";
                    document.getElementById("reversedInstructionsScreen").style.display = "none";
                    document.getElementById("alertingInstructionsScreen").style.display = "none";
                    const countdownContainer = document.getElementById("countdownContainer");
                    countdownContainer.style.display = "block";
                    countdownContainer.textContent = "3";
                    setTimeout(() => {
                        countdownContainer.textContent = "2";
                        setTimeout(() => {
                            countdownContainer.textContent = "1";
                            setTimeout(() => {
                                countdownContainer.style.display = "none";
                                if (testType === "normal") {
                                    startFlankerTest();
                                } else if (testType === "reversed") {
                                    startReversedFlankerTest();
                                } else if (testType === "alerting") {
                                    startAlertingTest();
                                }
                            }, 1000);
                        }, 1000);
                    }, 1000);
        }
        function showParticipantInfoScreen() {
            document.getElementById("startButton").style.display = "none";
            document.querySelector("h1").style.display = "none"; // Hide the title
            document.getElementById("participantInfoScreen").style.display = "block";
        }
        
        function submitParticipantInfo() {
            let participantId = document.getElementById("participantId").value.trim();
            let age = document.getElementById("participantAge").value.trim();
            let gender = document.getElementById("participantGender").value;
            let disclaimerAccepted = document.getElementById("disclaimerCheckbox").checked;

            if (!age || !gender) {
                alert("Please fill in age and gender fields.");
                return;
            }

            if (!disclaimerAccepted) {
                alert("Please read and agree to the disclaimer before continuing.");
                return;
            }

            participantInfo = {
                participantId: participantId,
                age: age,
                gender: gender,
                disclaimerAccepted: true,
                timestamp: new Date().toISOString()
            };

            sessionId = generateUniqueId();
            document.getElementById("participantInfoScreen").style.display = "none";
            document.getElementById("deviceSelectionScreen").style.display = "block";
        }
      
        function addActiveClass(button) {
            if (!isTouchDevice) {
                button.classList.add('active');
                setTimeout(() => {
                    button.classList.remove('active');
                }, 200);
            }
        }
        function handleArrowPress(key) {
            document.dispatchEvent(new KeyboardEvent('keydown', { key: key }));
        }
        function handleSpacePress() {
            document.dispatchEvent(new KeyboardEvent('keydown', { key: " " }));
        }
        function resetTest() {
            document.getElementById("result").style.display = "none";
            document.getElementById("restartButton").style.display = "none";
            spacebarPressCount = 0;
            alertingTestStarted = false;
            wrongGuesses = { normal: 0, reversed: 0 };
            totalCompletedTrials = 0;
            alertingTestActive = false;
            isFirstNormalTrial = true;
            isFirstReversedTrial = true;
            sessionId = generateUniqueId();
            updateProgressBar();
            showParticipantInfoScreen();
        }
        function showInstructions() {
            document.getElementById("instructionsScreen").style.display = "block";
            toggleProgressBar(false);
        }
        function startFlankerTest() {
            document.getElementById("arrowContainer").style.display = "block";
            toggleProgressBar(true);
            if (isTouchDevice) {
                document.getElementById("touchButtonsContainer").style.display = "block";
            }
            if (isTouchDevice) {
                document.getElementById("spaceButton").style.display = "none";
                document.getElementById("leftButton").style.display = "inline-flex";
                document.getElementById("rightButton").style.display = "inline-flex";
            }
            trials = generateTrials();
            currentTrial = 0;
            reactionTimes = { normal: { congruent: [], incongruent: [] }, reversed: { congruent: [], incongruent: [] } };
            wrongGuesses = { normal: 0, reversed: 0 };
            currentPhase = "flanker";
            currentFlankerType = "normal";
            isFirstNormalTrial = true;
            runTrial();
        }
        function generateTrials() {
            let trialsArray = Array(10).fill(true).map((_, i) => i % 2 === 0);
            return trialsArray.sort(() => Math.random() - 0.5);
        }
        function runTrial() {
            if (currentTrial >= trials.length) {
                if (currentPhase === "flanker") {
                    showReversedFlankerInstructions();
                } else if (currentPhase === "reversed") {
                    showAlertingInstructions();
                }
                return;
            }
            document.getElementById("arrowContainer").style.display = "block";
            let isCongruent = trials[currentTrial];
            let targetDirection = Math.random() < 0.5 ? "←" : "→";
            let flankerDirection = isCongruent ? targetDirection : (targetDirection === "←" ? "→" : "←");
            let arrowRow = `${flankerDirection} ${flankerDirection} ${targetDirection} ${flankerDirection} ${flankerDirection}`;
            document.getElementById("arrowContainer").textContent = arrowRow;
            let startTime = Date.now();
            function keyPressHandler(event) {
                document.getElementById("arrowContainer").style.display = "none";
                if ((targetDirection === "←" && event.key === "ArrowLeft") || (targetDirection === "→" && event.key === "ArrowRight")) {
                    if (!isFirstNormalTrial) {
                        if (isCongruent) {
                            reactionTimes.normal.congruent.push(Date.now() - startTime);
                        } else {
                            reactionTimes.normal.incongruent.push(Date.now() - startTime);
                        }
                    }
                } else {
                    if (!isFirstNormalTrial) {
                        wrongGuesses.normal++;
                    }
                }
                document.removeEventListener("keydown", keyPressHandler);
                let delay = Math.floor(Math.random() * (1000 - 250 + 1)) + 250;
                setTimeout(() => {
                    if (isFirstNormalTrial) {
                        isFirstNormalTrial = false;
                    }
                    currentTrial++;
                    totalCompletedTrials++;
                    updateProgressBar();
                    runTrial();
                }, delay);
            }
            document.addEventListener("keydown", keyPressHandler);
        }
      
        function showReversedFlankerInstructions() {
            currentPhase = "reversed";
            if (isTouchDevice) {
                document.getElementById("touchButtonsContainer").style.display = "none";
            }
            document.getElementById("reversedInstructionsScreen").style.display = "block";
            toggleProgressBar(false);
        }
        function startReversedFlankerTest() {
            document.getElementById("arrowContainer").style.display = "block";
            toggleProgressBar(true);
            if (isTouchDevice) {
                document.getElementById("touchButtonsContainer").style.display = "block";
            }
            if (isTouchDevice) {
                document.getElementById("spaceButton").style.display = "none";
                document.getElementById("leftButton").style.display = "inline-flex";
                document.getElementById("rightButton").style.display = "inline-flex";
                document.getElementById("leftButton").onclick = function() {
                    handleReversedArrowPress("ArrowLeft");
                };
                document.getElementById("rightButton").onclick = function() {
                    handleReversedArrowPress("ArrowRight");
                };
            }
            trials = generateTrials();
            currentTrial = 0;
            currentFlankerType = "reversed";
            isFirstReversedTrial = true;
            runReversedTrial();
        }
        function handleReversedArrowPress(key) {
            document.dispatchEvent(new KeyboardEvent('keydown', { key: key }));
        }
        function runReversedTrial() {
            if (currentTrial >= trials.length) {
                showAlertingInstructions();
                return;
            }
            document.getElementById("arrowContainer").style.display = "block";
            let isCongruent = trials[currentTrial];
            let targetDirection = Math.random() < 0.5 ? "←" : "→";
            let flankerDirection = isCongruent ? targetDirection : (targetDirection === "←" ? "→" : "←");
            let arrowRow = `${flankerDirection} ${flankerDirection} ${targetDirection} ${flankerDirection} ${flankerDirection}`;
            document.getElementById("arrowContainer").textContent = arrowRow;
            let startTime = Date.now();
            function keyPressHandler(event) {
                document.getElementById("arrowContainer").style.display = "none";
                if ((targetDirection === "←" && event.key === "ArrowRight") || (targetDirection === "→" && event.key === "ArrowLeft")) {
                    if (!isFirstReversedTrial) {
                        if (isCongruent) {
                            reactionTimes.reversed.congruent.push(Date.now() - startTime);
                        } else {
                            reactionTimes.reversed.incongruent.push(Date.now() - startTime);
                        }
                    }
                } else {
                    if (!isFirstReversedTrial) {
                        wrongGuesses.reversed++;
                    }
                }
                document.removeEventListener("keydown", keyPressHandler);
                let delay = Math.floor(Math.random() * (1000 - 250 + 1)) + 250;
                setTimeout(() => {
                    if (isFirstReversedTrial) {
                        isFirstReversedTrial = false;
                    }
                    currentTrial++;
                    totalCompletedTrials++;
                    updateProgressBar();
                    runReversedTrial();
                }, delay);
            }
            document.addEventListener("keydown", keyPressHandler);
        }

      
        function showAlertingInstructions() {
            currentPhase = "alerting";
            if (isTouchDevice) {
                document.getElementById("touchButtonsContainer").style.display = "none";
            }
            document.getElementById("alertingInstructionsScreen").style.display = "block";
            toggleProgressBar(false);
            spacebarPressCount = 0;
            if (isTouchDevice) {
                document.getElementById("leftButton").style.display = "none";
                document.getElementById("rightButton").style.display = "none";
                document.getElementById("spaceButton").style.display = "inline-flex";
                document.querySelector("#alertingInstructionsScreen p:nth-child(2)").textContent = 
                    "Tap the button as soon as you see the dot appear.";
            }
        }
      
      
      
        function startAlertingTest() {
            document.getElementById("alertingTestScreen").style.display = "block";
            toggleProgressBar(true);
            alertingTestStarted = true;
            if (isTouchDevice) {
                document.getElementById("touchButtonsContainer").style.display = "block";
            }
            if (!isTouchDevice) {
                document.addEventListener("keydown", trackKeyboardSpacebarPresses);
            }
            runMultipleAlertingTests(0);
        }
        function trackKeyboardSpacebarPresses(event) {
            if (event.key === " " && alertingTestStarted) {
                spacebarPressCount++;
            }
        }
        function runMultipleAlertingTests(testIndex) {
            if (testIndex >= 5) {
                document.getElementById("alertingTestScreen").style.display = "none";
                if (!isTouchDevice) {
                    document.removeEventListener("keydown", trackKeyboardSpacebarPresses);
                }
                showResults();
                return;
            }
            let delay = Math.floor(Math.random() * (3000 - 1000 + 1)) + 1000;
            setTimeout(() => {
                document.getElementById("alertingStimulus").style.display = "block";
                let startTime = Date.now();
                let reactionRecorded = false;
                function spacebarTestHandler(event) {
                    if (event.key === " " && !reactionRecorded) {
                        reactionRecorded = true;
                        let reactionTime = Date.now() - startTime;
                        alertingReactionTimes.push(reactionTime);
                        document.removeEventListener("keydown", spacebarTestHandler);
                        document.getElementById("alertingStimulus").style.display = "none";
                        totalCompletedTrials++;
                        updateProgressBar();
                        runMultipleAlertingTests(testIndex + 1);
                    }
                }
                function touchSpacebarHandler() {
                    if (!reactionRecorded) {
                        reactionRecorded = true;
                        let reactionTime = Date.now() - startTime;
                        alertingReactionTimes.push(reactionTime);
                        document.getElementById("alertingStimulus").style.display = "none";
                        totalCompletedTrials++;
                        updateProgressBar();
                        setTimeout(() => {
                            runMultipleAlertingTests(testIndex + 1);
                        }, 100);
                    }
                }
                if (isTouchDevice) {
                    let spaceButton = document.getElementById("spaceButton");
                    spaceButton.addEventListener("click", touchSpacebarHandler, { once: true });
                } else {
                    document.addEventListener("keydown", spacebarTestHandler);
                }
            }, delay);
        }
        
        function assessRiskLevel(results) {
            // Initialize array to track indicators above cutoff level
            let indicatorsAboveCutoff = [];
            
            // Check normal flanker congruent reaction time
            if (results.normalFlanker.congruent > CUTOFFS.normalFlanker.congruent) {
                indicatorsAboveCutoff.push("Normal task reaction time (matching arrows)");
            }
            
            // Check normal flanker incongruent reaction time
            if (results.normalFlanker.incongruent > CUTOFFS.normalFlanker.incongruent) {
                indicatorsAboveCutoff.push("Normal task reaction time (conflicting arrows)");
            }
            
            // Check normal flanker wrong guesses
            if (results.normalFlanker.wrongGuesses > CUTOFFS.normalFlanker.wrongGuesses) {
                indicatorsAboveCutoff.push("Normal task accuracy");
            }
            
            // Check reversed flanker congruent reaction time
            if (results.reversedFlanker.congruent > CUTOFFS.reversedFlanker.congruent) {
                indicatorsAboveCutoff.push("Reversed task reaction time (matching arrows)");
            }
            
            // Check reversed flanker incongruent reaction time
            if (results.reversedFlanker.incongruent > CUTOFFS.reversedFlanker.incongruent) {
                indicatorsAboveCutoff.push("Reversed task reaction time (conflicting arrows)");
            }
            
            // Check reversed flanker wrong guesses
            if (results.reversedFlanker.wrongGuesses > CUTOFFS.reversedFlanker.wrongGuesses) {
                indicatorsAboveCutoff.push("Reversed task accuracy");
            }
            
            // Check alerting test reaction time
            if (results.alertingTest.averageReactionTime > CUTOFFS.alertingTest.reactionTime) {
                indicatorsAboveCutoff.push("Alertness reaction time");
            }
            
            // Check spacebar press count
            if (results.alertingTest.spacebarPressCount > CUTOFFS.alertingTest.spacebarPressCount) {
                indicatorsAboveCutoff.push("Focus control");
            }
            
            // Determine risk level based on number of indicators above cutoff
            let riskLevel;
            let riskColor;
            let recommendations;
            
            if (indicatorsAboveCutoff.length === 0) {
                riskLevel = "Low Risk";
                riskColor = "#4CAF50"; // Green
                recommendations = [
                    "Your cognitive performance is within normal range.",
                    "Continue with your current routine and maintain a balanced lifestyle.",
                    "Regular exercise, adequate sleep, a balanced diet, and socialization will help sustain your cognitive health."
                ];
            } else if (indicatorsAboveCutoff.length === 1) {
                riskLevel = "Medium Risk";
                riskColor = "#FF9800"; // Orange
                recommendations = [
                    "Some aspects of your cognitive performance may benefit from attention.",
                    "Consider consulting with a health professional.",
                    "Ensure you're getting 7-9 hours of quality sleep, maintain a balanced diet, and socialize."
                ];
            } else {
                riskLevel = "High Risk";
                riskColor = "#F44336"; // Red
                recommendations = [
                    "Multiple aspects of your cognitive performance show potential signs of chronique fatigue, depression, and/or dementia.",
                    "Consider consulting with a health professional.",
                    "Repeat the test later in the day/week for confirmation"
                ];
            }
            
            return {
                level: riskLevel,
                color: riskColor,
                indicators: indicatorsAboveCutoff,
                recommendations: recommendations
            };
        }
        
        function showResults() {
            alertingTestStarted = false;
            if (isTouchDevice) {
                document.getElementById("touchButtonsContainer").style.display = "none";
            }
            toggleProgressBar(false);
        
            // Calculate cumulative response times and total errors
            const cumulativeResponseTime = reactionTimes.normal.congruent.concat(reactionTimes.normal.incongruent, reactionTimes.reversed.congruent, reactionTimes.reversed.incongruent)
                .reduce((acc, time) => acc + time, 0);
            const totalErrors = wrongGuesses.normal + wrongGuesses.reversed;
        
            // Display the results with cumulative response time and errors
            document.getElementById("result").style.display = "block";
            document.getElementById("result").innerHTML = `
                <p><strong>Thank You</strong></p>
                <p>Your assessment has been completed successfully.</p>
                <p><strong>Cumulative Response Time:</strong> ${cumulativeResponseTime} ms</p>
                <p><strong>Total Errors:</strong> ${totalErrors}</p>
                <canvas id="responseTimeChart" style="max-width: 600px; margin: auto;"></canvas>
            `;
        
            // Fetch historical data based on Participant ID
            if (participantInfo.participantId) {
                fetchHistoricalData(participantInfo.participantId);
            }
        
            document.getElementById("restartButton").style.display = "block";
        
            // Optionally, include email subscription section as before
            document.getElementById("result").innerHTML += `
                <div id="emailSubscriptionSection" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                    <p><strong>Stay on Track with Your Cognitive Health</strong></p>
                    <p style="font-size: 14px; margin-bottom: 15px;">Enter your email to receive one weekly reminder to complete this test regularly. We'll only send you reminders - nothing else!</p>
                    <div style="display: flex; margin-bottom: 10px;">
                        <input type="email" id="reminderEmail" placeholder="Your email address" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px;">
                        <button id="subscribeButton" style="background-color: #4CAF50; color: white; border: none; border-radius: 4px; padding: 0 15px; cursor: pointer;">Subscribe</button>
                    </div>
                    <p id="subscriptionMessage" style="font-size: 14px; margin-top: 10px; display: none;"></p>
                </div>
            `;
        
            // Add the event listener for the subscribe button
            document.getElementById("subscribeButton").addEventListener("click", subscribeToReminders);
        }

        function fetchHistoricalData(participantId) {
            firebaseDb.ref('tests').orderByChild('participantId').equalTo(participantId).once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const cumulativeTimes = [];
                    const timestamps = [];
        
                    for (const key in data) {
                        if (data.hasOwnProperty(key)) {
                            cumulativeTimes.push(data[key].cumulativeResponseTime);
                            timestamps.push(new Date(data[key].timestamp).toLocaleDateString());
                        }
                    }
        
                    createGraph(cumulativeTimes, timestamps);
                } else {
                    console.log("No data found for this Participant ID.");
                }
            });
        }

        function createGraph(cumulativeTimes, timestamps) {
            const ctx = document.getElementById('responseTimeChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Cumulative Response Time (ms)',
                        data: cumulativeTimes,
                        borderColor: '#f4634c',
                        backgroundColor: 'rgba(244, 99, 76, 0.2)',
                        borderWidth: 2,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Response Time (ms)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Test Date'
                            }
                        }
                    }
                }
            });
        }
        
        function updateProgressBar() {
            let progress = (totalCompletedTrials / TOTAL_TRIALS) * 100;
            document.getElementById("progressBar").style.width = `${progress}%`;
        }
    </script>
</body>
</html>
