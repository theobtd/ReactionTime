<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flanker & Alerting Test</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            overflow: hidden;
        }
        button {
            font-size: 18px;
            padding: 10px 20px;
            cursor: pointer;
            margin: 10px;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            border: none;
        }
        button:hover {
            background-color: #0056b3;
        }
        #arrowContainer {
            font-size: 100px;
            margin-top: 20px;
            display: none;
        }
        #result {
            display: none;
        }
        #alertingTestScreen p {
            font-size: 50px;
            display: none;
        }
        #progressBarContainer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ddd;
        }
        #progressBar {
            height: 10px;
            background-color: #4caf50;
            width: 0;
        }
        h1 {
            position: fixed;
            top: 20px;
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Flanker Task</h1>
    <button id="startButton">Start Test</button>
    <div id="arrowContainer"></div>
    <p id="result"></p>
    <button id="restartButton" style="display: none;">Restart</button>

    <!-- Flanker Test Instructions -->
    <div id="instructionsScreen" style="display: none;">
        <p><strong>INSTRUCTIONS</strong></p>
        <p>Identify the direction of the center arrow and ignore the surrounding ones.</p>
        <button id="understoodButton">Understood</button>
    </div>

    <!-- Alerting Test Instructions -->
    <div id="alertingInstructionsScreen" style="display: none;">
        <p><strong>ALERTING NETWORK TEST</strong></p>
        <p>Press the spacebar as soon as you see the dot appear.</p>
        <button id="understoodAlertingButton">Understood!</button>
    </div>

    <!-- Alerting Test Screen -->
    <div id="alertingTestScreen" style="display: none;">
        <p id="alertingStimulus">●</p>
    </div>

    <div id="progressBarContainer">
        <div id="progressBar"></div>
    </div>

    <script>
        let trials = [];
        let currentTrial = 0;
        let reactionTimes = { congruent: 0, incongruent: 0 };
        let wrongGuesses = 0;
        let alertingReactionTimes = [];

        document.getElementById("startButton").addEventListener("click", showInstructions);
        document.getElementById("restartButton").addEventListener("click", resetTest);
        document.getElementById("understoodButton").addEventListener("click", startTest);
        document.getElementById("understoodAlertingButton").addEventListener("click", startAlertingTest);

        function resetTest() {
            document.getElementById("result").style.display = "none";
            document.getElementById("restartButton").style.display = "none";
            showInstructions();
        }

        function showInstructions() {
            document.getElementById("startButton").style.display = "none";
            document.getElementById("instructionsScreen").style.display = "block";
        }

        function startTest() {
            document.getElementById("instructionsScreen").style.display = "none";
            document.getElementById("arrowContainer").style.display = "block";
            trials = generateTrials();
            currentTrial = 0;
            reactionTimes = { congruent: 0, incongruent: 0 };
            wrongGuesses = 0;
            runTrial();
        }

        function generateTrials() {
            let trialsArray = Array(20).fill(true).map((_, i) => i % 2 === 0);
            return trialsArray.sort(() => Math.random() - 0.5);
        }

        function runTrial() {
            if (currentTrial >= trials.length) {
                endTest();
                return;
            }

            // Ensure the arrows are visible at the start of the trial
            document.getElementById("arrowContainer").style.display = "block";

            let isCongruent = trials[currentTrial];
            let targetDirection = Math.random() < 0.5 ? "←" : "→";
            let flankerDirection = isCongruent ? targetDirection : (targetDirection === "←" ? "→" : "←");
            let arrowRow = `${flankerDirection} ${flankerDirection} ${targetDirection} ${flankerDirection} ${flankerDirection}`;
            document.getElementById("arrowContainer").textContent = arrowRow;
            let startTime = Date.now();

            function keyPressHandler(event) {
                // Hide arrows immediately after the answer
                document.getElementById("arrowContainer").style.display = "none";

                if ((targetDirection === "←" && event.key === "ArrowLeft") || (targetDirection === "→" && event.key === "ArrowRight")) {
                    let reactionTime = Date.now() - startTime;
                    isCongruent ? reactionTimes.congruent += reactionTime : reactionTimes.incongruent += reactionTime;
                } else {
                    wrongGuesses++;
                }
                document.removeEventListener("keydown", keyPressHandler);

                // Random delay before the next trial (between 250ms and 1000ms)
                let delay = Math.floor(Math.random() * (1000 - 250 + 1)) + 250;
                setTimeout(() => {
                    currentTrial++;
                    updateProgressBar();
                    runTrial(); // Start the next trial after the delay
                }, delay);
            }
            document.addEventListener("keydown", keyPressHandler);
        }

        function endTest() {
            document.getElementById("arrowContainer").style.display = "none";
            document.getElementById("alertingInstructionsScreen").style.display = "block";
        }

        function startAlertingTest() {
            document.getElementById("alertingInstructionsScreen").style.display = "none";
            document.getElementById("alertingTestScreen").style.display = "block";

            runMultipleAlertingTests(0);
        }

        function runMultipleAlertingTests(testIndex) {
            if (testIndex >= 5) {
                document.getElementById("alertingTestScreen").style.display = "none";
                showResults();
                return;
            }

            let delay = Math.floor(Math.random() * (3000 - 1000 + 1)) + 1000;
            setTimeout(() => {
                document.getElementById("alertingStimulus").style.display = "block";
                let startTime = Date.now();

                function spacebarHandler(event) {
                    if (event.key === " ") {
                        let reactionTime = Date.now() - startTime;
                        alertingReactionTimes.push(reactionTime);
                        document.removeEventListener("keydown", spacebarHandler);
                        document.getElementById("alertingStimulus").style.display = "none";
                        runMultipleAlertingTests(testIndex + 1);
                    }
                }
                document.addEventListener("keydown", spacebarHandler);
            }, delay);
        }

        function showResults() {
            let totalAlertingReactionTime = alertingReactionTimes.reduce((acc, time) => acc + time, 0);
            let averageAlertingReactionTime = totalAlertingReactionTime / alertingReactionTimes.length;

            document.getElementById("result").innerHTML = `  
                <strong>Results:</strong><br>
                Total Reaction Time (Congruent): ${reactionTimes.congruent} ms<br>
                Total Reaction Time (Incongruent): ${reactionTimes.incongruent} ms<br>
                Total Wrong Guesses: ${wrongGuesses}<br>
                <strong>Alerting Test Reaction Times:</strong><br>
                Total: ${totalAlertingReactionTime} ms<br>
                Average: ${averageAlertingReactionTime.toFixed(2)} ms`;
            document.getElementById("result").style.display = "block";
            document.getElementById("restartButton").style.display = "block";
        }

        function updateProgressBar() {
            let progress = ((currentTrial + 1) / trials.length) * 100;
            document.getElementById("progressBar").style.width = `${progress}%`;
        }
    </script>
</body>
</html>
