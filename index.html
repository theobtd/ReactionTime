<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flanker & Alerting Test</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            overflow: hidden;
            margin: 0;
            padding-top: 50px; /* Add space for the fixed title */
        }
        /* Title fixed at the top */
        h1 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #f4f4f4;
            color: #333;
            padding: 10px 0;
            margin: 0;
            font-size: 24px;
            text-align: center;
            z-index: 10;
        }
        button {
            font-size: 18px;
            padding: 10px 20px;
            cursor: pointer;
            margin: 10px;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            border: none;
        }
        button:hover {
            background-color: #0056b3;
        }
        #arrowContainer {
            font-size: 100px;
            margin-top: 20px;
            display: none;
        }
        #result {
            display: none;
        }
        #alertingTestScreen p {
            font-size: 50px;
            display: none;
        }
        /* Progress bar styling */
        #progressBarContainer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ddd;
            height: 10px;
        }
        #progressBar {
            width: 0%;
            height: 100%;
            background-color: #007bff;
        }
    </style>
</head>
<body>
    <h1>Flanker Task</h1> <!-- Fixed title -->
    <button id="startButton">Start Test</button>
    <div id="arrowContainer"></div>
    <p id="result"></p>
    <button id="restartButton" style="display: none;">Restart</button>

    <!-- Flanker Test Instructions -->
    <div id="instructionsScreen" style="display: none;">
        <p><strong>INSTRUCTIONS</strong></p>
        <p>Identify the direction of the center arrow and ignore the surrounding ones.</p>
        <button id="understoodButton">Understood</button>
    </div>

    <!-- Alerting Test Instructions -->
    <div id="alertingInstructionsScreen" style="display: none;">
        <p><strong>ALERTING NETWORK TEST</strong></p>
        <p>Press the spacebar as soon as you see the dot appear.</p>
        <button id="understoodAlertingButton">Understood!</button>
    </div>

    <!-- Alerting Test Screen -->
    <div id="alertingTestScreen" style="display: none;">
        <p id="alertingStimulus">●</p>
    </div>

    <!-- Progress Bar -->
    <div id="progressBarContainer">
        <div id="progressBar"></div>
    </div>

    <script>
        let trials = [];
        let currentTrial = 0;
        let reactionTimes = { congruent: 0, incongruent: 0 };
        let wrongGuesses = 0;
        let alertingReactionTime = 0;

        const totalFlankerTrials = 21; // Number of trials in the flanker test
        const totalTestSteps = totalFlankerTrials + 1; // Adding 1 step for the alerting test

        document.getElementById("startButton").addEventListener("click", showInstructions);
        document.getElementById("restartButton").addEventListener("click", resetTest);
        document.getElementById("understoodButton").addEventListener("click", startTest);
        document.getElementById("understoodAlertingButton").addEventListener("click", startAlertingTest);

        function resetTest() {
            document.getElementById("result").style.display = "none";
            document.getElementById("restartButton").style.display = "none";
            showInstructions();
        }

        function showInstructions() {
            document.getElementById("startButton").style.display = "none";
            document.getElementById("instructionsScreen").style.display = "block";
        }

        function startTest() {
            document.getElementById("instructionsScreen").style.display = "none";
            document.getElementById("arrowContainer").style.display = "block";
            trials = generateTrials();
            currentTrial = 0;
            reactionTimes = { congruent: 0, incongruent: 0 };
            wrongGuesses = 0;
            runTrial();
        }

        function generateTrials() {
            let trialsArray = Array(totalFlankerTrials).fill(true).map((_, i) => i % 2 === 0); // Start with alternating congruent/incongruent trials
            // Shuffle initially
            trialsArray = trialsArray.sort(() => Math.random() - 0.5);

            // Ensure no consecutive trials have the same direction
            for (let i = 1; i < trialsArray.length; i++) {
                if (trialsArray[i] === trialsArray[i - 1]) {
                    // If the current trial is the same as the previous one, change it to the opposite
                    trialsArray[i] = trialsArray[i] === true ? false : true;
                }
            }

            return trialsArray;
        }

        function runTrial() {
            if (currentTrial >= trials.length) {
                // Flanker test completed, update progress bar and start alerting test
                updateProgressBarFlankerTest();
                endTest();
                return;
            }

            let isCongruent = trials[currentTrial];
            let targetDirection = Math.random() < 0.5 ? "←" : "→";
            let flankerDirection = isCongruent ? targetDirection : (targetDirection === "←" ? "→" : "←");
            let arrowRow = `${flankerDirection} ${flankerDirection} ${targetDirection} ${flankerDirection} ${flankerDirection}`;
            document.getElementById("arrowContainer").textContent = arrowRow;
            let startTime = Date.now();

            function keyPressHandler(event) {
                if ((targetDirection === "←" && event.key === "ArrowLeft") || (targetDirection === "→" && event.key === "ArrowRight")) {
                    let reactionTime = Date.now() - startTime;
                    isCongruent ? reactionTimes.congruent += reactionTime : reactionTimes.incongruent += reactionTime;
                } else {
                    wrongGuesses++;
                }
                document.removeEventListener("keydown", keyPressHandler);
                currentTrial++;
                updateProgressBarFlankerTest();
                runTrial();
            }
            document.addEventListener("keydown", keyPressHandler);
        }

        function updateProgressBarFlankerTest() {
            // Update progress for the flanker test trials
            const progress = ((currentTrial) / totalFlankerTrials) * 95; // Use 95% for flanker trials
            document.getElementById("progressBar").style.width = progress + "%";
        }

        function updateProgressBarAfterAlertingTest() {
            // Set progress to 100% after alerting test
            document.getElementById("progressBar").style.width = "100%";
        }

        function endTest() {
            document.getElementById("arrowContainer").style.display = "none";
            document.getElementById("alertingInstructionsScreen").style.display = "block";
        }

        function startAlertingTest() {
            document.getElementById("alertingInstructionsScreen").style.display = "none";
            document.getElementById("alertingTestScreen").style.display = "block";

            let delay = Math.floor(Math.random() * (3000 - 1000 + 1)) + 1000; // Random delay between 1 to 3 seconds

            // Hide the stimulus initially
            document.getElementById("alertingStimulus").style.display = "none";

            // Set a timeout for when the dot should appear
            setTimeout(() => {
                document.getElementById("alertingStimulus").style.display = "block"; // Show the dot
                let startTime = Date.now(); // Record the time when the dot appears

                // Define the spacebar handler that will be triggered when the user presses the spacebar
                function spacebarHandler(event) {
                    if (event.key === " ") {
                        alertingReactionTime = Date.now() - startTime; // Calculate reaction time
                        document.removeEventListener("keydown", spacebarHandler); // Remove event listener
                        document.getElementById("alertingTestScreen").style.display = "none"; // Hide alerting test screen
                        updateProgressBarAfterAlertingTest(); // Set progress to 100% after alerting test
                        showResults(); // Show results after spacebar press
                    }
                }

                document.addEventListener("keydown", spacebarHandler); // Listen for spacebar press
            }, delay);
        }

        function showResults() {
            document.getElementById("result").innerHTML = ` 
                <strong>Results:</strong><br>
                Total Reaction Time (Congruent): ${reactionTimes.congruent} ms<br>
                Total Reaction Time (Incongruent): ${reactionTimes.incongruent} ms<br>
                Total Wrong Guesses: ${wrongGuesses}<br>
                <strong>Alerting Test Reaction Time:</strong> ${alertingReactionTime} ms`;
            document.getElementById("result").style.display = "block";
            document.getElementById("restartButton").style.display = "block";
        }
    </script>
</body>
</html>
